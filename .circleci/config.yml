# iOS CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/ios-migrating-from-1-2/ for more details
#
version: 2.1

commands:
  early_return_for_forked_prs:
    description: >-
      If this build is from a fork, stop executing the current job and return success.
      This is useful to avoid steps that will fail due to missing credentials.
    steps:
      - run:
          name: skip left steps and return immediately from current job if current build is from a forked PR
          command: |
            if [ -n "$CIRCLE_PR_NUMBER" ]; then
              echo "Nothing to do for forked PRs, so marking this step successful"
              circleci step halt
            fi

  update_brew:
    description: >-
      update brew
    steps:
      - run:
          name: update brew
          command: |
            HOMEBREW_LOGS=~/homebrew-logs
            HOMEBREW_TEMP=~/homebrew-temp
            brew update

  set_environment_variables:
    description: >-
      set environment variables
    steps:
      - run:
          name: set environment variables
          command: |
            sdkName=aws-ios-sdk
            echo "export sdkName=$sdkName" >> $BASH_ENV

            release_bucket=${S3_RELEASE_BUCKET}
            echo "export release_bucket=$release_bucket" >> $BASH_ENV

            release_tag=${CIRCLE_TAG}
            echo "export release_tag=$release_tag" >> $BASH_ENV

            release_version=${CIRCLE_TAG}
            echo "export release_version=$release_version" >> $BASH_ENV

            sdkNameWithVersion="$sdkName-$release_version"
            echo "export sdkNameWithVersion=$sdkNameWithVersion" >> $BASH_ENV

            pre_name=$(echo "${CIRCLE_SHA1}" | cut -c1-7)
            override_test_variable_name=OVERRIDE_TEST_${pre_name}
            echo "export override_test_variable_name=$override_test_variable_name" >> $BASH_ENV

  quit_for_nominorversion:
    description: >-
      If current release is not a minor version bump, stop executing the current job and return success.
    steps:
      - run:
          name: skip left steps and return immediately from current job if current release is not a minor version bump
          command: |
            echo $release_version
            maintenance=$(echo $release_version | sed "s/[0-9]*.[0-9]*.\([0-9]*\)/\1/")
            echo $maintenance
            if [ "$maintenance" != "0" ]; then
              echo "This is not minor version bump release, so marking this step successful"
              circleci step halt
            fi

  bump_version_pre:
    description: >-
      prepare bump version
    steps:
      - run:
          name: checkout repository for bump version
          command: |
            if [ -z "$target_branch" ]
            then
              target_branch="master"
            fi

            git config --local user.name "${GITHUB_BUMPVERSION_USER}"
            git clone "https://github.com/${GITHUB_BUMPVERSION_USER}/${bumpversion_repo_name}.git"
            cd ${bumpversion_repo_name}
            git fetch
            branches=$(git branch)
            if [[ $branches == *"bump_version"* ]]; then
              echo "the branch is already pesent"
              git checkout bump_version
            else
              echo "create new branch bump_version"
              git checkout -b bump_version
            fi
            git remote add upstream https://github.com/${bumpversion_repo_user}/${bumpversion_repo_name}
            git remote -v
            git fetch upstream
            git reset --hard upstream/$target_branch
            echo "push update the branch"
            git push --force -q https://${GITHUB_BUMPVERSION_TOKEN}@github.com/${GITHUB_BUMPVERSION_USER}/${bumpversion_repo_name}.git

  bump_version_post:
    description: >-
      check in bump version change
    steps:
      - run:
          name: stage changes
          command: |
            cd ${bumpversion_repo_name}
            git config --local user.name "${GITHUB_BUMPVERSION_USER}"
            gitstatus=$(git status)
            echo $gitstatus
            if [[ $gitstatus == *"Changes not staged for commit:"* ]]; then
              git add .
            else
              echo "No changes for sample application bump version"
              circleci step halt
            fi
      - run:
          name: check in changes
          command: |
            if [ -z "$target_branch" ]
            then
              target_branch="master"
            fi
            cd ${bumpversion_repo_name}
            git status
            git config --local user.name "${GITHUB_BUMPVERSION_USER}"
            git commit -m "${bump_version_message}"
            git push --force -q https://${GITHUB_BUMPVERSION_TOKEN}@github.com/${GITHUB_BUMPVERSION_USER}/${bumpversion_repo_name}.git
            title="${bump_version_pr_title}"
            content="${bump_version_message}"
            echo "title:$title"
            echo "content:$content"
            python3 ../CircleciScripts/create_pullrequest.py "${GITHUB_BUMPVERSION_USER}" "${GITHUB_BUMPVERSION_TOKEN}" "$title" "$content" "$target_branch" "${GITHUB_BUMPVERSION_USER}:bump_version" ${bumpversion_repo_user} ${bumpversion_repo_name}
  configure_aws:
    description: >-
      install aws cli and configure android aws release profile
    steps:
      - run:
          name: install aws cli
          command: |
            HOMEBREW_NO_AUTO_UPDATE=1 brew install awscli
      - run:
          name: configure aws profile
          command: |
            aws configure --profile build_resources set region us-east-1
            echo -e "[build_resources]\naws_access_key_id=${BUILD_RESOURCES_AWS_ACCESS_KEY_ID}\naws_secret_access_key=${BUILD_RESOURCES_AWS_SECRET_ACCESS_KEY}\n" >> ~/.aws/credentials

            aws configure --profile sdk_s3_release set region us-east-1
            echo -e "[sdk_s3_release]\naws_access_key_id=${S3_RELEASE_AWS_ACCESS_KEY_ID}\naws_secret_access_key=${S3_RELEASE_AWS_SECRET_ACCESS_KEY}\n" >> ~/.aws/credentials
  pre_start_simulator:
    description: >-
      pre start simulator, build may fail is simulator is not started
    steps:
      - run:
          name: pre-start simulator
          command: |
            bash CircleciScripts/pre_start_simulator.sh
  skip_test_job:
    description: >-
      check if the test job can be skipped
    steps:
      - run:
          name: skip the test job if commit message require skipping tests
          command: |
            commitmessage=$(git log --format=%B -n 1 ${CIRCLE_SHA1})
            if [[ "$commitmessage" =~ .*"[skip test]".* ]]
            then
               echo "skip the test job required from commit message"
               circleci step halt
            fi
      - run:
          name: skip the test job if the release process is triggered by circleci
          command: |
            skipflag=$(echo "${SKIPTEST_FOR_RELEASE}") | tr '[:upper:]' '[:lower:]'
            if ! [ -z "${CIRCLE_TAG}" ] && [ "$skipflag" == "true" ]
            then
              tagmessage="git show ${CIRCLE_TAG}"
              echo $tagmessage
              if [[ "$tagmessage" =~ .*"Trigger release from circleci".* ]]
              then
                 echo "The release is triggered by circleci. skip the job"
                 circleci step halt
              fi
            fi
      - run:
          name: skip the test job if this is merged from develop by circleci
          command: |
            skipflag=$(echo "${SKIPTEST_FOR_MASTER}") | tr '[:upper:]' '[:lower:]'
            commitmessage=$(git log --format=%B -n 1 ${CIRCLE_SHA1})
            if [ "$skipflag" == "true" ] && [[ "$commitmessage" =~ .*"[Merge develop to master by circleci]".* ]]
            then
               echo "This is merged from develop by circleci. skip the test job"
               circleci step halt
            fi

  override_test_job:
    description: >-
      skip the test job is project variable OVERRIDE_TEST is set with TRUE
    steps:

      - run:
          name: skip test if the commit is already tested
          command: |
            echo "${TESTED_COMMITID}:${CIRCLE_SHA1}"
            skipflag=$(echo "${SKIPTESTEDCHANGE}" | tr '[:upper:]' '[:lower:]')
            if [ "${TESTED_COMMITID}" == "${CIRCLE_SHA1}" ] && [ "${skipflag}" != "true" ]
            then
              echo "skip test as the change ${CIRCLE_SHA1} is already tested"
              circleci step halt
            fi
      - run:
          name: check_for_test_override
          command: |
              echo "override_test_variable_name=$override_test_variable_name"
              override_test_value=$(eval "echo $"${override_test_variable_name}"")
              override_test_value=$(echo "${override_test_value}" | tr '[:upper:]' '[:lower:]')
              if [ "${override_test_value}" == "true" ]; then
                echo "project environment variable OVERRIDE_TEST is set with TRUE, skip all tests"
                circleci step halt
              fi
  skip_job_unless_required:
    description: >-
      skip job unless required
    steps:
      - run:
          name: skip_job_from_environment_variable
          command: |
              variable_name=SKIP_JOB_${CIRCLE_JOB}

              skipjob_flag=$(eval "echo $"${variable_name}"")
              skipjob_flag=$(echo "${skipjob_flag}" | tr '[:upper:]' '[:lower:]')
              if [ "${skipjob_flag}" == "true" ]
              then
                echo "skip current job as ${variable_name} is set in project environment variables"
                circleci step halt
              fi

jobs:
  build:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - checkout
      - set_environment_variables
      - run:
          name: create credentials
          command: |
            touch AWSCoreTests/Resources/credentials.json
            touch AWSAuthSDK/Tests/AWSMobileClientTests/awsconfiguration.json
            touch AWSAuthSDK/Tests/AWSMobileClientTests/credentials-mc.json
      - pre_start_simulator
      - run:
          name: build sdk
          command: |
            xcodebuild build -project AWSiOSSDKv2.xcodeproj -scheme AWSAllTests -sdk iphonesimulator -destination "${destination}"
            xcodebuild build -project AWSAuthSDK/AWSAuthSDK.xcodeproj -scheme AWSAuthSDKAllTargets -sdk iphonesimulator -destination "${destination}"
  unittest:
    macos:
      xcode: "11.4.0"
    steps:
      - set_environment_variables
      - override_test_job
      - skip_job_unless_required
      - checkout
      - skip_test_job
      - run:
          name: create credentials
          command: |
            touch AWSCoreTests/Resources/credentials.json
      - pre_start_simulator
      - run:
          name: build sdk
          command: xcodebuild build-for-testing -project AWSiOSSDKv2.xcodeproj -scheme AWSAllTests -sdk iphonesimulator -destination "${destination}"
      - run :
          name: run unit tests
          command: bash CircleciScripts/run_unittests.sh "test_result" "${destination}"
      - run:
          name : check unit test result
          command : bash CircleciScripts/check_test_result.sh "test_result"
      - store_artifacts:
          path: test_result
  pre_integrationtest:
    macos:
      xcode: "11.4.0"
    environment: 
      TERM: xterm-256color
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - override_test_job
      - run:
          name: get override test variable name
          command: |
            echo "override_test_variable_name=$override_test_variable_name"
      - run:
          name: reset OVERRIDE_TEST environment variable
          command: |
            override_test_value=$(eval "echo $"${override_test_variable_name}"")
            if ! [ -z "$override_test_value" ]
            then
               echo "reset ${override_test_variable_name} value"
              parameters='{"name":"'${override_test_variable_name}'","value":"FALSE"}'
              curl -X POST \
                -H "Content-type: application/json" \
                -H "Accept: application/json" \
                -d "$parameters" \
                "https://circleci.com/api/v1.1/project/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/envvar?circle-token=${CIRCLE_API_USER_TOKEN}"
            fi
      - checkout
      - set_environment_variables
      - configure_aws
      - run:
          name: create credentials
          command: |
            echo ${IOS_TESTS_CREDENTIALS_JSON} | base64 --decode > AWSCoreTests/Resources/credentials.json
            aws --profile build_resources s3 cp s3://ios-circleci-payload/awsconfiguration.json AWSAuthSDK/Tests/AWSMobileClientTests/awsconfiguration.json
            aws --profile build_resources s3 cp s3://ios-circleci-payload/credentials-mc.json AWSAuthSDK/Tests/AWSMobileClientTests/credentials-mc.json
      - pre_start_simulator
      - run:
          name: build sdk
          command: |
            xcodebuild build-for-testing -project AWSiOSSDKv2.xcodeproj -scheme AWSAllTests -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./build_result/AWSiOSSDKv2
            xcodebuild build-for-testing -project AWSAuthSDK/AWSAuthSDK.xcodeproj -scheme AWSMobileClient -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./build_result/AWSAuthSDK
      - save_cache:
          key: build_result-{{ .Revision }}
          paths:
            - build_result
  post_integrationtest:
    macos:
      xcode: "11.4.0"
    steps:
      #TODO need check why multiple key does not work here
      - skip_job_unless_required
      - override_test_job
      - restore_cache:
          key: test_result-{{ .Revision }}-APIGateway
      - restore_cache:
          key: test_result-{{ .Revision }}-AWSMobileClient
      - restore_cache:
          key: test_result-{{ .Revision }}-AutoScaling
      - restore_cache:
          key: test_result-{{ .Revision }}-CloudWatch
      - restore_cache:
          key: test_result-{{ .Revision }}-Cognito
      - restore_cache:
          key: test_result-{{ .Revision }}-Comprehend
      - restore_cache:
          key: test_result-{{ .Revision }}-Connect  
      - restore_cache:
          key: test_result-{{ .Revision }}-ConnectParticipant
      - restore_cache:
          key: test_result-{{ .Revision }}-Core
      - restore_cache:
          key: test_result-{{ .Revision }}-DynamoDB
      - restore_cache:
          key: test_result-{{ .Revision }}-EC2
      - restore_cache:
          key: test_result-{{ .Revision }}-ElasticLoadBalancing
      - restore_cache:
          key: test_result-{{ .Revision }}-IoT
      - restore_cache:
          key: test_result-{{ .Revision }}-KMS
      - restore_cache:
          key: test_result-{{ .Revision }}-Kinesis
      - restore_cache:
          key: test_result-{{ .Revision }}-KinesisVideoSignaling
      - restore_cache:
          key: test_result-{{ .Revision }}-Lambda
      - restore_cache:
          key: test_result-{{ .Revision }}-Lex
      - restore_cache:
          key: test_result-{{ .Revision }}-MachineLearning
      - restore_cache:
          key: test_result-{{ .Revision }}-MobileAnalytics
      - restore_cache:
          key: test_result-{{ .Revision }}-Pinpoint
      - restore_cache:
          key: test_result-{{ .Revision }}-Polly
      - restore_cache:
          key: test_result-{{ .Revision }}-Rekognition
      - restore_cache:
          key: test_result-{{ .Revision }}-S3
      - restore_cache:
          key: test_result-{{ .Revision }}-SES
      - restore_cache:
          key: test_result-{{ .Revision }}-SNS
      - restore_cache:
          key: test_result-{{ .Revision }}-SQS
      - restore_cache:
          key: test_result-{{ .Revision }}-SageMakerRuntime
      - restore_cache:
          key: test_result-{{ .Revision }}-Textract
      - restore_cache:
          key: test_result-{{ .Revision }}-Transcribe
      - restore_cache:
          key: test_result-{{ .Revision }}-TranscribeStreaming
      - restore_cache:
          key: test_result-{{ .Revision }}-Translate
      - store_artifacts:
          path: integration_test_result
      - run:
          name: set environment variables
          command: |
            parameters='{"name":"TESTED_COMMITID","value":"'${CIRCLE_SHA1}'"}'
            curl -X POST \
              -H "Content-type: application/json" \
              -H "Accept: application/json" \
              -d "$parameters" \
              "https://circleci.com/api/v1.1/project/github/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}/envvar?circle-token=${CIRCLE_API_USER_TOKEN}"


  integrationtest:
    description: run integration tests
    parameters:
      groupname:
        default: stable_testList
        type: string
    macos:
      xcode: "11.4.0"
    steps:
      - set_environment_variables
      - override_test_job
      - skip_job_unless_required
      - early_return_for_forked_prs
      - checkout
      - skip_test_job
      - pre_start_simulator
      - restore_cache:
          key: build_result-{{ .Revision }}
      - run:
          name: install json parser
          command: pip3 install demjson
      - run:
          name: create credentials
          command: |
            echo ${IOS_TESTS_CREDENTIALS_JSON} | base64 --decode > AWSCoreTests/Resources/credentials.json
      - run :
          name: run integration tests
          command: |
            mkdir integration_test_result
            python3 CircleciScripts/run_integrationtests.py CircleciScripts/IntegrationTestsConfiguration.json "integration_test_result" "<< parameters.groupname >>" "${destination}" "./build_result"
      - run:
          name : check integration test result
          command : |
            echo "testresult=$testresult"
            if [ "$testresult" == "0" ]
            then
                echo "test succeed!"
            else
                echo "There are test failures"
                exit 1
            fi
      - store_artifacts:
          path: integration_test_result
      - save_cache:
          key: test_result-{{ .Revision }}-{{ .Environment.CIRCLE_JOB }}
          paths:
            - integration_test_result

  release_tag:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - checkout
      - update_brew
      - run:
          name: install github-release
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install github-release
      - run:
          name: release the tag
          command: |
            tagdescription=$(sed -n '/## '${CIRCLE_TAG}'/,/## [0-9]*\.[0-9]*\.[0-9]/p' CHANGELOG.md | sed '1d' | sed '$d')
            tagname="AWS SDK for iOS "${CIRCLE_TAG}
            echo "$tagdescription" | github-release release -s ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} --name "$tagname" -d -

  release_carthage:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - checkout
      - pre_start_simulator
      - update_brew
      - run:
          name: install github-release
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install github-release
      - run:
          name: install aws cli
          command: |
            HOMEBREW_NO_AUTO_UPDATE=1 brew install awscli
      - run:
          name: upgrade carthage
          command: |
            HOMEBREW_NO_AUTO_UPDATE=1 brew upgrade carthage
      - run:
          name: build
          command: |
            xcodebuild -project AWSiOSSDKv2.xcodeproj -scheme AWSCore -sdk iphonesimulator -destination "${destination}" build
      - run:
          name: Build Carthage
          command: |
            carthage build --no-skip-current | tee buildout.txt
          no_output_timeout: 100m
      - run:
          name: Create Carthage Archive
          command: python3 ./CircleciScripts/create_carthage_archive.py
          no_output_timeout: 20m
      - run:
          name: upload file to git release
          command: github-release upload -s ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} -f aws-sdk-ios-carthage.framework.zip -n aws-sdk-ios-carthage.framework.zip

  release_cocoapods:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - checkout
      - run:
          name: Release cocoapods
          command: python3 ./CircleciScripts/cocoapods_release.py
          no_output_timeout: 20m

  release_docs:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - checkout
      - run:
          name: Install jazzy
          command: |
            sudo gem install jazzy --source http://rubygems.org
      - run:
          name: generate documents
          command: bash ./CircleciScripts/generate_documentation.sh
      - run:
          name: copy documents
          command: |
            git config --local user.name "AWS"
            git checkout gh-pages
            rm -rf docs/reference
            mv docs_tmp docs/reference
      - run:
          name: checkin documents
          command: |
            for dirPath in docs/reference/* ; do
              sdkName=$( basename "$dirPath" )
              git add "$dirPath" && git commit -m "Update API documentation for ${sdkName} ${CIRCLE_TAG}"
              git prune
            done
            git push -q https://${GITHUB_TOKEN}@github.com/aws/aws-sdk-ios.git

  add_doc_tag:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - checkout
      - run:
          name: Add documentation tags to gh-pages
          command: |
            git config --local user.name "AWS"
            git checkout gh-pages
            git tag -a ${CIRCLE_TAG}_api_docs -m "Add documentation tags to version ${CIRCLE_TAG}"
            git push --tags -q https://${GITHUB_TOKEN}@github.com/aws-amplify/aws-sdk-ios.git

  bump_ios_sampleapp_version:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - quit_for_nominorversion
      - checkout
      - run:
          name: checkout repository for bump version
          command: |
            SAMPLE_APPS_REPO_ACCOUNT=awslabs
            echo "export SAMPLE_APPS_REPO_ACCOUNT=$SAMPLE_APPS_REPO_ACCOUNT" >> $BASH_ENV
            git clone "https://github.com/${SAMPLE_APPS_REPO_ACCOUNT}/aws-sdk-ios-samples.git"
      - run:
          name: update version
          command:
            python3 CircleciScripts/bump_iossample_version.py "$(pwd)/aws-sdk-ios-samples" $release_version
      - run:
          name: build projects
          command:
            python3 CircleciScripts/build_iossample.py "$(pwd)/aws-sdk-ios-samples"
      - run:
          name: stage changes
          command: |
            cd aws-sdk-ios-samples
            git config --local user.name "AWS"
            gitstatus=$(git status)
            echo $gitstatus
            if [[ $gitstatus == *"Changes not staged for commit:"* ]]; then
              git add .
            else
              echo "No changes for sample application bump version"
              circleci step halt
            fi
      - run:
          name: check in changes
          command: |
            cd aws-sdk-ios-samples
            git status
            git config --local user.name "AWS"
            git commit -m "Update sample app dependency to ${release_version}"
            git push -q https://${GITHUB_BUMPVERSION_TOKEN}@github.com/${SAMPLE_APPS_REPO_ACCOUNT}/aws-sdk-ios-samples.git

  bump_ios_amplifydocs_version:
    macos:
      xcode: "11.4.0"
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - quit_for_nominorversion
      - checkout
      - run:
          name: set_bumpversion_environment
          command: |
            bumpversion_repo_user=aws-amplify
            bumpversion_repo_name=docs
            minorversion=$(echo $release_version | sed "s/\([0-9]*.[0-9]*\).[0-9]*/\1/")
            echo ${minorversion}
            bump_version_message="Update iOS docs to ${release_version}"
            bump_version_pr_title="Update iOS docs to ${release_version}"
            echo "export bumpversion_repo_user=$bumpversion_repo_user" >> $BASH_ENV
            echo "export bumpversion_repo_name=$bumpversion_repo_name" >> $BASH_ENV
            echo "export minorversion=$minorversion" >> $BASH_ENV
            echo "export bump_version_message='${bump_version_message}'" >> $BASH_ENV
            echo "export bump_version_pr_title='${bump_version_pr_title}'" >> $BASH_ENV
            echo "bump_version_pr_title:$bump_version_pr_title"
      - bump_version_pre
      - run:
          name: bump version
          command:
            python3 CircleciScripts/bump_iosdocs_version.py "$(pwd)/${bumpversion_repo_name}/ios" $release_version
      - bump_version_post

  release_ios_s3:
    macos:
      xcode: "11.4.0"
    environment:
      TERM: xterm-256color
    steps:
      - skip_job_unless_required
      - checkout
      - update_brew
      - set_environment_variables
      - configure_aws
      - run:
          name: Build library
          command: |
            bash CircleciScripts/package.sh
      - run:
          name: Copy frameworks
          command: |
            mkdir -p "$sdkNameWithVersion/frameworks"
            cp -R builtFramework/framework/* "$sdkNameWithVersion/frameworks"
      - run:
          name: Copy SDK resource files
          command: |
            mkdir -p "$sdkNameWithVersion"
            python3 CircleciScripts/copy_resourcefiles.py "$(pwd)" "$(pwd)/$sdkNameWithVersion"
      - run:
          name: Zip SDK folder
          command: |
            zip -r "$sdkNameWithVersion.zip" "$sdkNameWithVersion"

      - run:
          name: Copy zip file
          command: |
            mkdir -p sdkfiles
            cp "$sdkNameWithVersion.zip" "sdkfiles/$sdkNameWithVersion.zip"
      - store_artifacts:
          path: sdkfiles
      - run:
          name: Upload to S3
          command: |
            aws s3api put-object --bucket "$release_bucket" --key "$sdkNameWithVersion.zip" --body "$sdkNameWithVersion.zip" --content-disposition "attachment;filename=$sdkNameWithVersion.zip" --acl public-read --profile sdk_s3_release
            aws s3api put-object --bucket "$release_bucket" --key "latest/$sdkName.zip" --body "$sdkNameWithVersion.zip" --content-disposition "attachment;filename=$sdkNameWithVersion.zip" --acl public-read --profile sdk_s3_release
      - run:
          name: Invalidate cloudfront
          command: |
            python3 CircleciScripts/cloudfront_invalidate.py sdk_s3_release "${S3_RELEASE_DISTRIBUTION_ID}" "latest/$sdkName.zip"
  bump_sdk_version:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - checkout
      - run:
          name: install python3-pip
          command: |
            echo "${newsdkversion}"
            sudo apt-get update
            sudo apt-get -y install python3-pip
      - run:
          name: Install json parser
          command: sudo pip3 install demjson
      - run:
          name: Install lxml
          command: sudo pip3 install lxml
      - run:
          name: set_bumpversion_environment
          command: |
            git config --local user.name AWS

            commitmessage=$(git log --format=%B -n 1 ${CIRCLE_SHA1})
            echo "commitmessage=$commitmessage"
            if [[ "$commitmessage" != *"bump version"* ]]
            then
               echo "To bump sdk version, the commit message should contain the words 'bump version'"
               circleci step halt
            fi

            release_version=$(head version | grep -E "^[0-9]+.[0-9]+.[0-9]+" | sed "s/^\([0-9]*.[0-9]*.[0-9]*\).*/\1/")
            if [ -z "release_version" ]
            then
              echo "version file does not have a correct version number"
              exit 1
            fi
            echo "release_version=[$release_version]"
            bumpversion_repo_user=${CIRCLE_PROJECT_USERNAME}
            bumpversion_repo_name=${CIRCLE_PROJECT_REPONAME}
            echo "bumpversion_repo_user:$bumpversion_repo_user"
            echo "bumpversion_repo_name:$bumpversion_repo_name"

            bump_version_message="[bump version $release_version]"
            bump_version_pr_title="bump iOS sdk version to ${release_version}"
            target_branch=test_develop
            echo "export bumpversion_repo_user=$bumpversion_repo_user" >> $BASH_ENV
            echo "export bumpversion_repo_name=$bumpversion_repo_name" >> $BASH_ENV
            echo "export release_version=$release_version" >> $BASH_ENV
            echo "export bump_version_message='${bump_version_message}'" >> $BASH_ENV
            echo "export bump_version_pr_title='${bump_version_pr_title}'" >> $BASH_ENV
            echo "export target_branch='${target_branch}'" >> $BASH_ENV
            echo "bump_version_pr_title:$bump_version_pr_title"
      - bump_version_pre
      - run:
          name: bump version
          command: |
            cp -R ${bumpversion_repo_name}/CircleciScripts/ CircleciScripts/
            python3 CircleciScripts/bump_sdk_version.py "$(pwd)/${bumpversion_repo_name}" $release_version
      - bump_version_post
  merge_to_master:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - skip_job_unless_required
      - checkout
      - set_environment_variables
      - run:
          name: merge change to master
          command: |
            git config --local user.name AWS
            git checkout master
            git fetch origin
            git reset origin/master
            git checkout .
            git clean -fd .
            commitlog=$(git log master -20)
            currentcommit="${CIRCLE_SHA1}"
            echo "currentcommit=$currentcommit"
            echo "$commitlog"
            if [[ "$commitlog" =~ .*"commit $currentcommit".* ]]
            then
               echo "The change is already merged"
            else
              echo "merge change from devlop to master"
              currentcommit="${CIRCLE_SHA1}"
              lastcommitmessage=$(git log --format=%B -n 1 ${currentcommit})

              git merge develop --no-edit --commit -m "[Merge develop to master by circleci] $lastcommitmessage"
              echo "push change"
              git push -q https://${GITHUB_TOKEN}@github.com/${CIRCLE_PROJECT_USERNAME}/${CIRCLE_PROJECT_REPONAME}.git
            fi
  prepare_release_sdk:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - skip_job_unless_required
      - checkout
      - set_environment_variables
      - run:
          name: trigger release_sdk if curremt commit is a bump version
          command: |
            bash CircleciScripts/prepare_release_sdk.sh
  create_pullrequest_for_modelupdate:
    docker:
      - image: circleci/android:api-27-alpha
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - checkout
      - run:
          name: create pull request
          command: |
            target_branch="develop"
            title=${CIRCLE_BRANCH}
            content="${CIRCLE_BRANCH}"
            python3 ./CircleciScripts/create_pullrequest.py "${GITHUB_USER}" "${GITHUB_TOKEN}" "$title" "$content" "$target_branch" "${CIRCLE_PROJECT_USERNAME}:${CIRCLE_BRANCH}" ${CIRCLE_PROJECT_USERNAME} ${CIRCLE_PROJECT_REPONAME}


workflows:
  version: 2
  bump_sdk_version:
    jobs:
      - bump_sdk_version:
          filters:
            branches:
              only:
                - bump_sdk_version
  build_and_test:
    jobs:
      - build:
          filters:
            branches:
              ignore: bump_sdk_version
      - unittest:
          requires:
            - build
          filters:
            branches:
              ignore: bump_sdk_version
      - create_pullrequest_for_modelupdate:
          filters:
            branches:
              only:
                - /^models-update-.+$/
      - pre_integrationtest:
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: APIGateway
          groupname: APIGateway
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: AutoScaling
          groupname: AutoScaling
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: AWSMobileClient
          groupname: AWSMobileClient
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: CloudWatch
          groupname: CloudWatch
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Cognito
          groupname: Cognito
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Comprehend
          groupname: Comprehend
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Connect
          groupname: Connect
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: ConnectParticipant
          groupname: ConnectParticipant
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Core
          groupname: Core
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: DynamoDB
          groupname: DynamoDB
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: EC2
          groupname: EC2
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: ElasticLoadBalancing
          groupname: ElasticLoadBalancing
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: IoT
          groupname: IoT
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Kinesis
          groupname: Kinesis
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: KinesisVideoSignaling
          groupname: KinesisVideoSignaling
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: KMS
          groupname: KMS
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Lambda
          groupname: Lambda
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Lex
          groupname: Lex
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: MobileAnalytics
          groupname: MobileAnalytics
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Pinpoint
          groupname: Pinpoint
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Polly
          groupname: Polly
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Rekognition
          groupname: Rekognition
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: SageMakerRuntime
          groupname: SageMakerRuntime
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: S3
          groupname: S3
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: SES
          groupname: SES
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: SNS
          groupname: SNS
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: SQS
          groupname: SQS
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Transcribe
          groupname: Transcribe
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: TranscribeStreaming
          groupname: TranscribeStreaming
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Translate
          groupname: Translate
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop

      - integrationtest:
          name: Textract
          groupname: Textract
          requires:
            - pre_integrationtest
          filters:
            branches:
              only:
                - master
                - develop
      - post_integrationtest:
          requires:
            - APIGateway
            - AWSMobileClient
            - AutoScaling
            - CloudWatch
            - Cognito
            - Comprehend
            - Connect
            - ConnectParticipant
            - Core
            - DynamoDB
            - EC2
            - ElasticLoadBalancing
            - IoT
            - KMS
            - Kinesis
            - KinesisVideoSignaling
            - Lambda
            - Lex
            - MobileAnalytics
            - Pinpoint
            - Polly
            - Rekognition
            - S3
            - SES
            - SNS
            - SQS
            - SageMakerRuntime
            - Textract
            - Transcribe
            - TranscribeStreaming
            - Translate
          filters:
            branches:
              only:
                - master
                - develop
      - merge_to_master:
          requires:
            - build
            - unittest
            - post_integrationtest
          filters:
            branches:
              only:
                - develop
      - prepare_release_sdk:
          requires:
            - build
            - unittest
            - post_integrationtest
          filters:
            branches:
              only:
                - master

  release_sdk:
    jobs:
      - build:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - unittest:
          requires:
            - build
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - pre_integrationtest:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: AWSMobileClient
          groupname: AWSMobileClient
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: SQS
          groupname: SQS
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: MobileAnalytics
          groupname: MobileAnalytics
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Rekognition
          groupname: Rekognition
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: SES
          groupname: SES
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: SNS
          groupname: SNS
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: CloudWatch
          groupname: CloudWatch
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: AutoScaling
          groupname: AutoScaling
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: APIGateway
          groupname: APIGateway
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Translate
          groupname: Translate
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Transcribe
          groupname: Transcribe
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: TranscribeStreaming
          groupname: TranscribeStreaming
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Polly
          groupname: Polly
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Cognito
          groupname: Cognito
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Comprehend
          groupname: Comprehend
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Core
          groupname: Core
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Kinesis
          groupname: Kinesis
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: KinesisVideoSignaling
          groupname: KinesisVideoSignaling
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: KMS
          groupname: KMS
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: ElasticLoadBalancing
          groupname: ElasticLoadBalancing
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: EC2
          groupname: EC2
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Lambda
          groupname: Lambda
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Lex
          groupname: Lex
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: IoT
          groupname: IoT
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Pinpoint
          groupname: Pinpoint
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: S3
          groupname: S3
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: DynamoDB
          groupname: DynamoDB
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Textract
          groupname: Textract
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: SageMakerRuntime
          groupname: SageMakerRuntime
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: Connect
          groupname: Connect
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - integrationtest:
          name: ConnectParticipant
          groupname: ConnectParticipant
          requires:
            - pre_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - post_integrationtest:
          requires:
            - AWSMobileClient
            - SQS
            - MobileAnalytics
            - Rekognition
            - SES
            - SNS
            - CloudWatch
            - AutoScaling
            - APIGateway
            - Translate
            - Transcribe
            - TranscribeStreaming
            - Polly
            - Cognito
            - Comprehend
            - Core
            - Kinesis
            - KinesisVideoSignaling
            - KMS
            - ElasticLoadBalancing
            - EC2
            - Lambda
            - Lex
            - IoT
            - Pinpoint
            - S3
            - DynamoDB
            - Textract
            - SageMakerRuntime
            - Connect
            - ConnectParticipant
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_ios_s3:
          requires:
            - unittest
            - post_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_tag:
          requires:
            - unittest
            - post_integrationtest
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_docs:
          requires:
            - release_tag
            - release_ios_s3
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - add_doc_tag:
          requires:
            - release_docs
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - bump_ios_amplifydocs_version:
          requires:
            - release_tag
            - release_ios_s3
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_cocoapods:
          requires:
            - add_doc_tag
            - bump_ios_amplifydocs_version
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_carthage:
          requires:
            - add_doc_tag
            - bump_ios_amplifydocs_version
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - bump_ios_sampleapp_version:
          requires:
            - release_tag
            - release_ios_s3
            - release_cocoapods
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
