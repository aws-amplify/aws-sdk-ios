# iOS CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/ios-migrating-from-1-2/ for more details
#
version: 2
jobs:
  test:
    macos:
      xcode: "9.4.0"
    steps: 
      - run:     
         name: test
         command: |
           carthage version
           brew outdated carthage || brew upgrade 
           carthage version

  release_carthage:
    # Specify the Xcode version to use
    macos:
      xcode: "9.2.0"

    steps: 
      - checkout
      - run:
          name: upgrade carthage
          command: brew outdated carthage || brew upgrade carthage
      - run:
          name: install github-release
          command: brew install github-release
      - run:
          name: Build Cathage
          command: carthage build --no-skip-current

      - run:
          name: Create Cathage Archive
          command: carthage archive  

      - run:
          name: Rename Cathage Achive
          command:  mv  AWSAPIGateway.framework.zip   aws-sdk-ios-carthage.framework.zip

      - run:
          name: release the tag
          command: |
            tagdescription=$(sed -n '/## '${CIRCLE_TAG}'/,/## [0-9]*\.[0-9]*\.[0-9]/p'  CHANGELOG.md | sed '1d' | sed '$d')
            tagname="AWS SDK for iOS "${CIRCLE_TAG}
            github-release release -s ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME}  -t ${CIRCLE_TAG} -d "$tagdescription" -n "$tagname"         
      - run:
          name: upload file to git release 
          command: github-release upload -s ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME}  -t ${CIRCLE_TAG} -f aws-sdk-ios-carthage.framework.zip -n aws-sdk-ios-carthage.framework.zip

  release_cocoapods:
    # Specify the Xcode version to use
    macos:
      xcode: "9.2.0"
    steps:
      - checkout  
       # Install CocoaPods
    #  - run:
     #     name: Install CocoaPods
      #    command: pod install

      # Build the app and run tests     
      
      - run:
          name: Release cocoapods
          command : python    cocoapods_release.py

workflows:
  version: 2
  build_and_test:
    jobs: 
      - test:
          filters:
            branches:
              only: mastertest      
      - release_carthage:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /test^[0-9]+.[0-9]+.[0-9]+$/
      - release_cocoapods:
          filters:
            branches:
              only: master1
    #          ignore: /.*/
     #       tags:
      #        only: /^[0-9]+.[0-9]+.[0-9]+$/