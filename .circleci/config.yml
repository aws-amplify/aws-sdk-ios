# iOS CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/ios-migrating-from-1-2/ for more details
#

################################################################################
# NOTE: If you make changes to this file, evaluate whether they also need to be
# made in the .circleci/config.yml files in the bump_sdk_version and gh-pages
# branches. The gh-pages config is quite straightforward and probably won't
# need the changes, but the bump_sdk_version branch has more build logic in it.
################################################################################

version: 2.1

orbs:
  aws-cli: circleci/aws-cli@3.1.4

commands:
  restore_gem:
    steps:
      - restore_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
      - run: bundle check || bundle install --path vendor/bundle --clean
      - save_cache:
          key: 1-gems-{{ checksum "Gemfile.lock" }}
          paths:
            - vendor/bundle

  update_brew:
    description: >-
      Update Homebrew
    steps:
      - run:
          name: Update Homebrew
          command: |
            HOMEBREW_LOGS=~/homebrew-logs
            HOMEBREW_TEMP=~/homebrew-temp
            brew upgrade
            brew update

  set_environment_variables:
    description: >-
      Set environment variables
    steps:
      - run:
          name: Set environment variables
          command: |
            sdkName=aws-ios-sdk
            echo "export sdkName=$sdkName" >> $BASH_ENV

            release_bucket=${XCF_RELEASE_BUCKET}
            echo "export release_bucket=$release_bucket" >> $BASH_ENV

            release_tag=${CIRCLE_TAG}
            echo "export release_tag=$release_tag" >> $BASH_ENV

            release_version=${CIRCLE_TAG}
            echo "export release_version=$release_version" >> $BASH_ENV

            sdkNameWithVersion="$sdkName-$release_version"
            echo "export sdkNameWithVersion=$sdkNameWithVersion" >> $BASH_ENV

            pre_name=$(echo "${CIRCLE_SHA1}" | cut -c1-7)
            override_test_variable_name=OVERRIDE_TEST_${pre_name}
            echo "export override_test_variable_name=$override_test_variable_name" >> $BASH_ENV

  quit_for_nominorversion:
    description: >-
      If current release is not a minor version bump, stop executing the current job and return success.
    steps:
      - run:
          name: Skip remaining steps if current release is not a minor version bump
          command: |
            echo $release_version
            maintenance=$(echo $release_version | sed "s/[0-9]*.[0-9]*.\([0-9]*\)/\1/")
            echo $maintenance
            if [ "$maintenance" != "0" ]; then
              echo "This is not minor version bump release, so marking this step successful"
              circleci step halt
            fi

  bump_version_pre:
    description: >-
      Prepare bump version
    steps:
      - run:
          name: Checkout repository for bump version
          command: |
            if [ -z "$target_branch" ]
            then
              target_branch="main"
            fi

            git config --local user.name "${GITHUB_BUMPVERSION_USER}"
            git clone "https://github.com/${GITHUB_BUMPVERSION_USER}/${bumpversion_repo_name}.git"
            cd ${bumpversion_repo_name}
            git fetch
            branches=$(git branch)
            if [[ $branches == *"bump_version"* ]]; then
              echo "the branch is already pesent"
              git checkout bump_version
            else
              echo "create new branch bump_version"
              git checkout -b bump_version
            fi
            git remote add upstream https://github.com/${bumpversion_repo_user}/${bumpversion_repo_name}
            git remote -v
            git fetch upstream
            git reset --hard upstream/$target_branch
            echo "push update the branch"
            git push --force -q https://${GITHUB_BUMPVERSION_TOKEN}@github.com/${GITHUB_BUMPVERSION_USER}/${bumpversion_repo_name}.git

  bump_version_post:
    description: >-
      Check in bump version change
    steps:
      - run:
          name: Stage changes
          command: |
            cd ${bumpversion_repo_name}
            git config --local user.name "${GITHUB_BUMPVERSION_USER}"
            gitstatus=$(git status)
            echo $gitstatus
            if [[ $gitstatus == *"Changes not staged for commit:"* ]]; then
              git add .
            else
              echo "No changes for sample application bump version"
              circleci step halt
            fi
      - run:
          name: Check in changes
          command: |
            if [ -z "$target_branch" ]
            then
              target_branch="main"
            fi
            cd ${bumpversion_repo_name}
            git status
            git config --local user.name "${GITHUB_BUMPVERSION_USER}"
            git commit -m "${bump_version_message}"
            git push --force -q https://${GITHUB_BUMPVERSION_TOKEN}@github.com/${GITHUB_BUMPVERSION_USER}/${bumpversion_repo_name}.git
            title="${bump_version_pr_title}"
            content="${bump_version_message}"
            echo "title:$title"
            echo "content:$content"
            python3 ../CircleciScripts/create_pullrequest.py "${GITHUB_BUMPVERSION_USER}" "${GITHUB_BUMPVERSION_TOKEN}" "$title" "$content" "$target_branch" "${GITHUB_BUMPVERSION_USER}:bump_version" ${bumpversion_repo_user} ${bumpversion_repo_name}

  configure_aws:
    description: >-
      Install aws cli and configure release profile
    steps:
      - run:
          name: Install AWS CLI
          command: |
            curl -O https://awscli.amazonaws.com/AWSCLIV2.pkg
            sudo installer -pkg AWSCLIV2.pkg -target /
      - run:
          name: Configure AWS profiles
          command: |
            aws configure --profile sdk_xcf_release set region us-east-1
            echo -e "[sdk_xcf_release]\naws_access_key_id=${XCF_AWS_ACCESS_KEY_ID}\naws_secret_access_key=${XCF_AWS_SECRET_ACCESS_KEY}\naws_session_token=${XCF_AWS_SESSION_TOKEN}\n" >> ~/.aws/credentials

  pre_start_simulator:
    description: >-
      Pre-start iOS Simulator, as the build may fail if it takes too long to start up during that step
    steps:
      - run:
          name: Pre-start iOS Simulator
          command: |
            bash CircleciScripts/pre_start_simulator.sh

  skip_test_job_by_commit_message:
    description: >-
      Check if the test job can be skipped
    steps:
      - run:
          name: Skip the test job if commit message require skipping tests
          command: |
            commitmessage=$(git log --format=%B -n 1 ${CIRCLE_SHA1})
            if [[ "$commitmessage" =~ .*"[skip test]".* ]]
            then
               echo "skip the test job required from commit message"
               circleci step halt
            fi
      - run:
          name: Skip the test job if the release process was triggered by CircleCI
          command: |
            skipflag=$(echo "${SKIPTEST_FOR_RELEASE}") | tr '[:upper:]' '[:lower:]'
            if ! [ -z "${CIRCLE_TAG}" ] && [ "$skipflag" == "true" ]
            then
              tagmessage="git show ${CIRCLE_TAG}"
              echo $tagmessage
              if [[ "$tagmessage" =~ .*"Trigger release from circleci".* ]]
              then
                 echo "The release was triggered by CircleCI. Skip the job"
                 circleci step halt
              fi
            fi

  skip_job_unless_required:
    description: >-
      Skip job unless required
    steps:
      - run:
          name: Skip job if SKIP_JOB flag is set
          command: |
              variable_name=SKIP_JOB_${CIRCLE_JOB}
              skipjob_flag=$(eval "echo $"${variable_name}"")
              skipjob_flag=$(echo "${skipjob_flag}" | tr '[:upper:]' '[:lower:]')
              if [ "${skipjob_flag}" == "true" ]
              then
                echo "Skipping current job as ${variable_name} environment variable is set"
                circleci step halt
              fi

  build_for_testing:
    parameters:
      project:
        type: string
      scheme:
        type: string
    steps:
      # This will restore cached values for dynamically generated resources
      # like testconfiguration.json, but it will be overwritten in the 'build'
      # step with fresh values
      - restore_cache:
          keys:
            - v1-testing-derived-data-<< parameters.scheme >>-{{ .Revision }}
      - run:
          name: Build << parameters.scheme >> for testing
          command: xcodebuild build-for-testing -project << parameters.project >> -scheme << parameters.scheme >> -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./testing_derived_data | tee "artifacts/build-<< parameters.scheme >>.log" | xcpretty
      - save_cache:
          key: v1-testing-derived-data-<< parameters.scheme >>-{{ .Revision }}
          paths:
            - testing_derived_data

  make_artifacts_directory:
    steps:
      - run:
          name: Make artifacts directory
          command: mkdir -p "artifacts"

  upload_artifacts:
    steps:
      - store_artifacts:
          path: artifacts

  shallow_checkout:
    # Workaround for https://github.com/guitarrapc/git-shallow-clone-orb/blob/main/src/commands/checkout.yml
    steps:
      - run:
          name: Checkout code shallow to working directory
          command: |
            export SSH_CONFIG_DIR=${SSH_CONFIG_DIR:-"${HOME}/.ssh"}
            echo "Using SSH Config Dir '$SSH_CONFIG_DIR'"
            mkdir -p $SSH_CONFIG_DIR
            echo -e 'github.com ecdsa-sha2-nistp256 AAAAE2VjZHNhLXNoYTItbmlzdHAyNTYAAAAIbmlzdHAyNTYAAABBBEmKSENjQEezOmxkZMy7opKgwFB9nkt5YRrYMjNuG5N87uRgg6CLrbo5wAdT/y6v0mKV0U2w0WZ2YB/++Tpockg=\n' >> "$SSH_CONFIG_DIR/known_hosts"
            chmod 0600 $SSH_CONFIG_DIR/known_hosts

            mkdir -p $CIRCLE_WORKING_DIRECTORY
            git clone --depth 1 "$CIRCLE_REPOSITORY_URL" $CIRCLE_WORKING_DIRECTORY
            cd $CIRCLE_WORKING_DIRECTORY

            if [ -n "$CIRCLE_TAG" ]; then
              echo 'Fetch tag'
              git fetch --depth 10 --force origin "+refs/tags/${CIRCLE_TAG}:refs/tags/${CIRCLE_TAG}"
            elif [[ $(echo $CIRCLE_PULL_REQUEST | grep -E "${CIRCLE_BRANCH}$") ]]; then
              echo 'Fetch pull request'
              git fetch --depth 10 --force origin "$CIRCLE_BRANCH/head:remotes/origin/$CIRCLE_BRANCH"
            else
              echo 'Fetch branch'
              git fetch --depth 10 --force origin "$CIRCLE_BRANCH:remotes/origin/$CIRCLE_BRANCH"
            fi

            echo "Checking out the CI HEAD"
            git reset --hard "$CIRCLE_SHA1"

jobs:
  build:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - restore_gem
      - set_environment_variables
      - pre_start_simulator
      - make_artifacts_directory
      - run:
          name: Build sdk
          command: |
            xcodebuild build -project AWSiOSSDKv2.xcodeproj -scheme AWSAllTests -sdk iphonesimulator -destination "${destination}" | tee "artifacts/build-AWSiOSSDKv2.log" | xcpretty
            xcodebuild build -project AWSAuthSDK/AWSAuthSDK.xcodeproj -scheme AWSAuthSDKAllTargets -sdk iphonesimulator -destination "${destination}" | tee "artifacts/build-AWSAuthSDK.log" | xcpretty
      - upload_artifacts

  build_test_host_apps:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - set_environment_variables
      - pre_start_simulator
      - make_artifacts_directory
      - build_for_testing:
          project: AWSiOSSDKv2.xcodeproj
          scheme: AWSAllTestsHost
      - build_for_testing:
          project: AWSAuthSDK/AWSAuthSDK.xcodeproj
          scheme: AWSAuthSDKTestApp
      - upload_artifacts

  unit_test:
    macos:
      xcode: "13.2.1"
    parameters:
      project:
        default: "AWSiOSSDKv2.xcodeproj"
        type: string
      scheme:
        type: string
    description: Run non-integration tests for << parameters.scheme >>
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - restore_gem
      - set_environment_variables
      - pre_start_simulator
      - make_artifacts_directory

      - when:
          condition:
            equal: [ << parameters.project >>, "AWSAuthSDK/AWSAuthSDK.xcodeproj" ]
          steps:
            - restore_cache:
                key: v1-testing-derived-data-AWSAuthSDKTestApp-{{ .Revision }}

      - restore_cache:
          key: v1-testing-derived-data-AWSAllTestsHost-{{ .Revision }}

      # After this step, the cache key
      # 'v1-testing-derived-data-<< parameters.scheme >>-{{ .Revision }}'
      # will include derived data for both
      # the specified scheme AND AWSAllTestsHost (and AWSAuthSDKTestApp if the
      # project is AWSAuthSDK)
      - build_for_testing:
          project: << parameters.project >>
          scheme: << parameters.scheme >>
      - run:
          name: Run unit tests for << parameters.scheme >>
          command: |
            xcodebuild test-without-building -project << parameters.project >> -scheme << parameters.scheme >> -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./testing_derived_data -only-testing:"<< parameters.scheme >>UnitTests" | tee "artifacts/unit-test-<< parameters.scheme >>.log" | xcpretty --simple --color --report junit

      - when:
          condition:
            equal: [ << parameters.scheme >>, "AWSCore" ]
          steps:
            - run:
                name: Additional AWSCore unit test targets
                command: |
                  xcodebuild test-without-building -project << parameters.project >> -scheme << parameters.scheme >> -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./testing_derived_data -only-testing:AWSCoreServiceConfigurationTest -only-testing:AWSCoreConfigurationTest | tee "artifacts/unit-test-AWSCore-additional-config-tests.log" | xcpretty --simple --color --report junit

      - store_test_results:
          path: build/reports
      - upload_artifacts

  integ_test:
    macos:
      xcode: "13.2.1"
    parameters:
      project:
        default: "AWSiOSSDKv2.xcodeproj"
        type: string
      scheme:
        type: string
    description: Run integration tests for << parameters.scheme >>
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - restore_gem
      - skip_test_job_by_commit_message
      - set_environment_variables
      - pre_start_simulator
      - make_artifacts_directory

      # Restore the cached derived data from previous jobs, which will include
      # the target under test, as well as the host apps
      - restore_cache:
          key: v1-testing-derived-data-<< parameters.scheme >>-{{ .Revision }}

      - run:
          name: Generate testconfiguration.json
          command: bash Scripts/generate-test-config.sh -p ios -v

      # Rebuilding uses the cached derived data and new testconfiguration to
      # quickly generate a new artifact to be tested
      - build_for_testing:
          project: << parameters.project >>
          scheme: << parameters.scheme >>

      - run:
          name: Run integration tests for << parameters.scheme >>
          command: |
            xcodebuild test-without-building -project << parameters.project >> -scheme << parameters.scheme >> -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./testing_derived_data -only-testing:"<< parameters.scheme >>Tests" | tee "artifacts/integ-test-<< parameters.scheme >>.log" | xcpretty --simple --color --report junit

      - when:
          condition:
            equal: [ << parameters.scheme >>, "AWSMobileClient" ]
          steps:
            - run:
                name: Additional AWSMobileClient test targets
                command: |
                  xcodebuild test-without-building -project << parameters.project >> -scheme << parameters.scheme >> -sdk iphonesimulator -destination "${destination}" -derivedDataPath ./testing_derived_data -only-testing:AWSMobileClientCustomAuthTests | tee "artifacts/integ-test-AWSMobileClientCustomAuthTests.log" | xcpretty --simple --color --report junit

      - store_test_results:
          path: build/reports
      - upload_artifacts

  release_tag:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - update_brew
      - run:
          name: Install github-release
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install github-release
      - run:
          name: Release the tag to GitHub
          command: |
            tagdescription=$(sed -n '/## '${CIRCLE_TAG}'/,/## [0-9]*\.[0-9]*\.[0-9]/p' CHANGELOG.md | sed '1d' | sed '$d')
            tagname="AWS SDK for iOS "${CIRCLE_TAG}
            echo "$tagdescription" | github-release release -s ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} --name "$tagname" -d -

  build_xcframeworks:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - pre_start_simulator
      - update_brew
      - run:
          name: Build XCFrameworks
          command: |
            python3 ./CircleciScripts/create_xcframeworks.py
          no_output_timeout: 100m
      - save_cache:
          key: build_xcframeworks-result-{{ .Revision }}
          paths:
            - xcframeworks

  release_carthage:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - pre_start_simulator
      - update_brew
      - run:
          name: Install github-release
          command: HOMEBREW_NO_AUTO_UPDATE=1 brew install github-release
      - restore_cache:
          key: build_xcframeworks-result-{{ .Revision }}
      - run:
          name: Create Carthage archive
          command: python3 ./CircleciScripts/create_carthage_archive.py
          no_output_timeout: 20m
      - run:
          name: Upload Carthage archive to GitHub release
          command: github-release upload -s ${GITHUB_TOKEN} -u ${CIRCLE_PROJECT_USERNAME} -r ${CIRCLE_PROJECT_REPONAME} -t ${CIRCLE_TAG} -f aws-sdk-ios-carthage.framework.zip -n aws-sdk-ios-carthage.framework.zip

  release_cocoapods:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - aws-cli/setup:
          role-arn: $AWS_OIDC_ROLE_ARN
          role-session-name: "${CIRCLE_WORKFLOW_JOB_ID}.release-cocoapods"
          session-duration: '900'
      - restore_gem
      - run:
          name: Release CocoaPods
          command: python3 ./CircleciScripts/cocoapods_release.py
          no_output_timeout: 100m

  release_docs:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - restore_gem
      - run:
          name: Generate documents
          command: bash ./CircleciScripts/generate_documentation.sh
          no_output_timeout: 100m
      - run:
          name: Copy documents
          command: |
            git config --local user.name "AWS"
            git fetch --depth 1 origin gh-pages
            git checkout gh-pages
            rm -rf docs/reference
            mv docs_tmp docs/reference
      - run:
          name: Checkin documents
          command: |
            for dirPath in docs/reference/* ; do
              sdkName=$( basename "$dirPath" )
              git add "$dirPath" && git commit -m "Update API documentation for ${sdkName} ${CIRCLE_TAG}"
              git prune
            done
            git push -q https://${GITHUB_TOKEN}@github.com/aws/aws-sdk-ios.git

  add_doc_tag:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - run:
          name: Add documentation tags to gh-pages
          command: |
            git config --local user.name "AWS"
            git fetch --depth 1 origin gh-pages
            git checkout gh-pages
            git tag -a ${CIRCLE_TAG}_api_docs -m "Add documentation tags to version ${CIRCLE_TAG}"
            git push --tags -q https://${GITHUB_TOKEN}@github.com/aws-amplify/aws-sdk-ios.git

  bump_ios_sampleapp_version:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - quit_for_nominorversion
      - shallow_checkout
      - run:
          name: Checkout repository for bump version
          command: |
            SAMPLE_APPS_REPO_ACCOUNT=awslabs
            echo "export SAMPLE_APPS_REPO_ACCOUNT=$SAMPLE_APPS_REPO_ACCOUNT" >> $BASH_ENV
            git clone "https://github.com/${SAMPLE_APPS_REPO_ACCOUNT}/aws-sdk-ios-samples.git"
      - run:
          name: Build projects
          command:
            python3 CircleciScripts/build_iossample.py "$(pwd)/aws-sdk-ios-samples"

  release_xcframeworks:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - set_environment_variables
      - configure_aws
      - restore_cache:
          key: build_xcframeworks-result-{{ .Revision }}
      - run:
          name: Install boto3
          command: sudo pip3 install boto3
      - run:
          name: Clone spm github repo
          command: |
            git clone "https://${GITHUB_SPM_RELEASE_TOKEN}@github.com/aws-amplify/aws-sdk-ios-spm.git"
            cd aws-sdk-ios-spm
            git checkout -b pre-release-${release_version}
            cd ..
      - run:
          name: Prepare xcframework archives and update Package.swift manifest
          command:
            python3 CircleciScripts/prepare_xcframework_archives.py $release_version
      - run:
          name: Upload xcframework archives
          command:
            python3 CircleciScripts/upload_xcframeworks.py $release_bucket $release_version sdk_xcf_release
      - run:
          name: Create PR for SPM package manifest
          command: |
            cd aws-sdk-ios-spm
            head_branch=pre-release-${release_version}
            target_branch="main"
            title="[release-spm]: Version and checksum update for ${release_version}"
            content="Update for package manifest and version for the next release"
            git checkout ${head_branch}
            git config --local user.name "${GITHUB_SPM_RELEASE_USER}"
            git add Package.swift
            git commit -m "$title"
            git push origin ${head_branch}
            cd ..
            python3 ./CircleciScripts/create_pullrequest.py "${GITHUB_SPM_RELEASE_USER}" "${GITHUB_SPM_RELEASE_TOKEN}" "$title" "$content" "$target_branch" "${head_branch}" "aws-amplify" "aws-sdk-ios-spm"

  release_xcframeworks_combined:
    macos:
      xcode: "13.2.1"
    environment:
      TERM: xterm-256color
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - update_brew
      - set_environment_variables
      - configure_aws
      - restore_cache:
          key: build_xcframeworks-result-{{ .Revision }}
      - run:
          name: Make directory structure
          command: |
            mkdir -p "$sdkNameWithVersion"
            mv "xcframeworks/output/XCF/" "$sdkNameWithVersion/frameworks"
            rm -rf "xcframeworks/output/"
      - run:
          name: Copy SDK resource files
          command: |
            python3 CircleciScripts/copy_resourcefiles.py "$(pwd)" "$(pwd)/$sdkNameWithVersion"
      - run:
          name: Zip SDK folder
          command: |
            zip -r "$sdkNameWithVersion.zip" "$sdkNameWithVersion"
      - run:
          name: Copy zip file
          command: |
            mkdir -p sdkfiles
            cp "$sdkNameWithVersion.zip" "sdkfiles/$sdkNameWithVersion.zip"
      - store_artifacts:
          path: sdkfiles
      - run:
          name: Upload to S3
          command: |
            aws s3api put-object --bucket "$release_bucket" --key "aws-sdk-ios/$sdkNameWithVersion.zip" --body "$sdkNameWithVersion.zip" --content-disposition "attachment;filename=$sdkNameWithVersion.zip" --profile sdk_xcf_release
            aws s3api put-object --bucket "$release_bucket" --key "aws-sdk-ios/latest/$sdkName.zip" --body "$sdkNameWithVersion.zip" --content-disposition "attachment;filename=$sdkNameWithVersion.zip" --profile sdk_xcf_release
      - run:
          name: Invalidate cloudfront
          command: |
            python3 CircleciScripts/cloudfront_invalidate.py sdk_xcf_release "${XCF_RELEASE_DISTRIBUTION_ID}" "aws-sdk-ios/latest/$sdkName.zip"

  bump_sdk_version:
    macos:
      xcode: "13.2.1"
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - shallow_checkout
      - run:
          name: Install JSON parser
          command: sudo pip3 install demjson
      - run:
          name: Install lxml
          command: sudo pip3 install lxml
      - run:
          name: Set environment variables
          command: |
            git config --local user.name AWS

            commitmessage=$(git log --format=%B -n 1 ${CIRCLE_SHA1})
            echo "commitmessage=$commitmessage"
            if [[ "$commitmessage" != *"bump version"* ]]
            then
               echo "To bump sdk version, the commit message should contain the words 'bump version'"
               circleci step halt
            fi

            release_version=$(head version | grep -E "^[0-9]+.[0-9]+.[0-9]+" | sed "s/^\([0-9]*.[0-9]*.[0-9]*\).*/\1/")
            if [ -z "release_version" ]
            then
              echo "version file does not have a correct version number"
              exit 1
            fi
            echo "release_version=[$release_version]"
            bumpversion_repo_user=${CIRCLE_PROJECT_USERNAME}
            bumpversion_repo_name=${CIRCLE_PROJECT_REPONAME}
            echo "bumpversion_repo_user:$bumpversion_repo_user"
            echo "bumpversion_repo_name:$bumpversion_repo_name"

            bump_version_message="[bump version $release_version]"
            bump_version_pr_title="bump iOS sdk version to ${release_version}"
            target_branch=main
            echo "export bumpversion_repo_user=$bumpversion_repo_user" >> $BASH_ENV
            echo "export bumpversion_repo_name=$bumpversion_repo_name" >> $BASH_ENV
            echo "export release_version=$release_version" >> $BASH_ENV
            echo "export bump_version_message='${bump_version_message}'" >> $BASH_ENV
            echo "export bump_version_pr_title='${bump_version_pr_title}'" >> $BASH_ENV
            echo "export target_branch='${target_branch}'" >> $BASH_ENV
            echo "bump_version_pr_title:$bump_version_pr_title"
      - bump_version_pre
      - run:
          name: Bump SDK version
          command: |
            cp -R ${bumpversion_repo_name}/CircleciScripts/ CircleciScripts/
            python3 CircleciScripts/bump_sdk_version.py "$(pwd)/${bumpversion_repo_name}" $release_version
      - bump_version_post

  prepare_release_sdk:
    docker:
      - image: circleci/android:api-27-alpha
    working_directory: /tmp/project
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - skip_job_unless_required
      - shallow_checkout
      - set_environment_variables
      - run:
          name: Trigger release_sdk if current commit is a bump version
          command: |
            bash CircleciScripts/prepare_release_sdk.sh

  create_pullrequest_for_modelupdate:
    docker:
      - image: circleci/android:api-27-alpha
    working_directory: /tmp/project
    environment:
      JVM_OPTS: -Xmx1024m
    steps:
      - skip_job_unless_required
      - set_environment_variables
      - shallow_checkout
      - run:
          name: Create pull request
          command: |
            target_branch="main"
            title=${CIRCLE_BRANCH}
            content="${CIRCLE_BRANCH}"
            python3 ./CircleciScripts/create_pullrequest.py "${GITHUB_USER}" "${GITHUB_TOKEN}" "$title" "$content" "$target_branch" "${CIRCLE_PROJECT_USERNAME}:${CIRCLE_BRANCH}" ${CIRCLE_PROJECT_USERNAME} ${CIRCLE_PROJECT_REPONAME}

all_integ_test_requires: &all_integ_test_requires
  requires:
    - build
    - integ_test_AWSMobileClient
    - integ_test_AWSAutoScaling
    - integ_test_AWSCloudWatch
    - integ_test_AWSComprehend
    - integ_test_AWSCore
    - integ_test_AWSDynamoDB
    - integ_test_AWSEC2
    - integ_test_AWSElasticLoadBalancing
    - integ_test_AWSIoT
    - integ_test_AWSKMS
    - integ_test_AWSKinesis
    - integ_test_AWSKinesisVideoSignaling
    - integ_test_AWSLambda
    - integ_test_AWSLex
    - integ_test_AWSPinpoint
    - integ_test_AWSPolly
    - integ_test_AWSRekognition
    - integ_test_AWSS3
    - integ_test_AWSSES
    - integ_test_AWSSNS
    - integ_test_AWSSQS
    - integ_test_AWSTextract
    - integ_test_AWSTranscribe
    - integ_test_AWSTranscribeStreaming
    - integ_test_AWSTranslate

workflows:
  version: 2

  bump_sdk_version:
    jobs:
      - bump_sdk_version:
          filters:
            branches:
              only:
                - bump_sdk_version

  build_and_test:
    jobs:
      - build:
          filters:
            branches:
              ignore: bump_sdk_version
      - build_test_host_apps:
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSAPIGateway
          name: unit_test_AWSAPIGateway
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSAutoScaling
          name: unit_test_AWSAutoScaling
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSCloudWatch
          name: unit_test_AWSCloudWatch
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSCognitoAuth
          name: unit_test_AWSCognitoAuth
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSCognitoIdentityProvider
          name: unit_test_AWSCognitoIdentityProvider
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSComprehend
          name: unit_test_AWSComprehend
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSConnect
          name: unit_test_AWSConnect
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSConnectParticipant
          name: unit_test_AWSConnectParticipant
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSCore
          name: unit_test_AWSCore
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSDynamoDB
          name: unit_test_AWSDynamoDB
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSEC2
          name: unit_test_AWSEC2
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSElasticLoadBalancing
          name: unit_test_AWSElasticLoadBalancing
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSIoT
          name: unit_test_AWSIoT
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSKMS
          name: unit_test_AWSKMS
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSKinesis
          name: unit_test_AWSKinesis
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSKinesisVideo
          name: unit_test_AWSKinesisVideo
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSKinesisVideoArchivedMedia
          name: unit_test_AWSKinesisVideoArchivedMedia
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSKinesisVideoSignaling
          name: unit_test_AWSKinesisVideoSignaling
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSKinesisVideoWebRTCStorage
          name: unit_test_AWSKinesisVideoWebRTCStorage
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSLambda
          name: unit_test_AWSLambda
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSLex
          name: unit_test_AWSLex
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSLogs
          name: unit_test_AWSLogs
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSMachineLearning
          name: unit_test_AWSMachineLearning
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          project: AWSAuthSDK/AWSAuthSDK.xcodeproj
          scheme: AWSMobileClient
          name: unit_test_AWSMobileClient
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSPinpoint
          name: unit_test_AWSPinpoint
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSPolly
          name: unit_test_AWSPolly
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSRekognition
          name: unit_test_AWSRekognition
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSS3
          name: unit_test_AWSS3
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSSES
          name: unit_test_AWSSES
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSSNS
          name: unit_test_AWSSNS
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSSQS
          name: unit_test_AWSSQS
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSSageMakerRuntime
          name: unit_test_AWSSageMakerRuntime
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSSimpleDB
          name: unit_test_AWSSimpleDB
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSTextract
          name: unit_test_AWSTextract
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSTranscribe
          name: unit_test_AWSTranscribe
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSTranscribeStreaming
          name: unit_test_AWSTranscribeStreaming
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSTranslate
          name: unit_test_AWSTranslate
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSLocation
          name: unit_test_AWSLocation
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSChimeSDKMessaging
          name: unit_test_AWSChimeSDKMessaging
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - unit_test:
          scheme: AWSChimeSDKIdentity
          name: unit_test_AWSChimeSDKIdentity
          requires:
            - build
            - build_test_host_apps
          filters:
            branches:
              ignore: bump_sdk_version

      - create_pullrequest_for_modelupdate:
          filters:
            branches:
              only:
                - /^models-update-.+$/

      - integ_test:
          project: AWSAuthSDK/AWSAuthSDK.xcodeproj
          scheme: AWSMobileClient
          name: integ_test_AWSMobileClient
          requires:
            - unit_test_AWSMobileClient
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSAutoScaling
          name: integ_test_AWSAutoScaling
          requires:
            - unit_test_AWSAutoScaling
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSCloudWatch
          name: integ_test_AWSCloudWatch
          requires:
            - unit_test_AWSCloudWatch
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSComprehend
          name: integ_test_AWSComprehend
          requires:
            - unit_test_AWSComprehend
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSCore
          name: integ_test_AWSCore
          requires:
            - unit_test_AWSCore
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSDynamoDB
          name: integ_test_AWSDynamoDB
          requires:
            - unit_test_AWSDynamoDB
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSEC2
          name: integ_test_AWSEC2
          requires:
            - unit_test_AWSEC2
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSElasticLoadBalancing
          name: integ_test_AWSElasticLoadBalancing
          requires:
            - unit_test_AWSElasticLoadBalancing
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSIoT
          name: integ_test_AWSIoT
          requires:
            - unit_test_AWSIoT
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSKMS
          name: integ_test_AWSKMS
          requires:
            - unit_test_AWSKMS
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSKinesis
          name: integ_test_AWSKinesis
          requires:
            - unit_test_AWSKinesis
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSKinesisVideoSignaling
          name: integ_test_AWSKinesisVideoSignaling
          requires:
            - unit_test_AWSKinesisVideoSignaling
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSLambda
          name: integ_test_AWSLambda
          requires:
            - unit_test_AWSLambda
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSLex
          name: integ_test_AWSLex
          requires:
            - unit_test_AWSLex
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSPinpoint
          name: integ_test_AWSPinpoint
          requires:
            - unit_test_AWSPinpoint
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSPolly
          name: integ_test_AWSPolly
          requires:
            - unit_test_AWSPolly
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSRekognition
          name: integ_test_AWSRekognition
          requires:
            - unit_test_AWSRekognition
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSS3
          name: integ_test_AWSS3
          requires:
            - unit_test_AWSS3
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSSES
          name: integ_test_AWSSES
          requires:
            - unit_test_AWSSES
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSSNS
          name: integ_test_AWSSNS
          requires:
            - unit_test_AWSSNS
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSSQS
          name: integ_test_AWSSQS
          requires:
            - unit_test_AWSSQS
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSTextract
          name: integ_test_AWSTextract
          requires:
            - unit_test_AWSTextract
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSTranscribe
          name: integ_test_AWSTranscribe
          requires:
            - unit_test_AWSTranscribe
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSTranscribeStreaming
          name: integ_test_AWSTranscribeStreaming
          requires:
            - unit_test_AWSTranscribeStreaming
          filters:
            branches:
              only:
                - main

      - integ_test:
          scheme: AWSTranslate
          name: integ_test_AWSTranslate
          requires:
            - unit_test_AWSTranslate
          filters:
            branches:
              only:
                - main


      - prepare_release_sdk:
          <<: *all_integ_test_requires
          filters:
            branches:
              only:
                - main

  release_sdk:
    jobs:
      - build:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - build_xcframeworks:
          requires:
            - build
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_xcframeworks:
          requires:
            - build_xcframeworks
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_xcframeworks_combined:
          requires:
            - release_xcframeworks
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_tag:
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_docs:
          requires:
            - release_tag
            - release_xcframeworks_combined
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - add_doc_tag:
          requires:
            - release_docs
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - release_cocoapods:
          requires:
            - add_doc_tag
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
          context: amplify-swift-aws-oidc
      - release_carthage:
          requires:
            - build_xcframeworks
            - add_doc_tag
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
      - bump_ios_sampleapp_version:
          requires:
            - release_tag
            - release_xcframeworks_combined
            - release_cocoapods
          filters:
            branches:
              ignore: /.*/
            tags:
              only: /^[0-9]+.[0-9]+.[0-9]+$/
